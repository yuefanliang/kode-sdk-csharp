name: Publish to NuGet

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        type: string

env:
  DOTNET_VERSION: '10.0.x'
  CONFIGURATION: Release

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
      packages: write  # Required for publishing packages
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build
        run: dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore
      
      - name: Run tests
        run: dotnet test --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal
      
      - name: Pack NuGet packages
        run: dotnet pack --configuration ${{ env.CONFIGURATION }} --no-build --output ./nupkgs
      
      - name: List packages
        run: ls -lh ./nupkgs/
      
      - name: Publish to NuGet.org
        run: |
          echo "Publishing packages to NuGet.org..."
          
          # 按依赖顺序发布包
          # 1. 首先发布 SourceGenerator (被 Sdk 引用)
          echo "Publishing Kode.Agent.SourceGenerator..."
          dotnet nuget push ./nupkgs/Kode.Agent.SourceGenerator.*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
          
          # 等待包索引完成
          echo "Waiting for SourceGenerator to be indexed..."
          sleep 90
          
          # 2. 发布核心 Sdk
          echo "Publishing Kode.Agent.Sdk..."
          dotnet nuget push ./nupkgs/Kode.Agent.Sdk.*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
          
          # 等待 Sdk 包索引完成
          echo "Waiting for Sdk to be indexed..."
          sleep 120
          
          # 3. 发布依赖 Sdk 的其他包
          echo "Publishing remaining packages..."
          for pkg in ./nupkgs/Kode.Agent.Tools.Builtin.*.nupkg \
                     ./nupkgs/Kode.Agent.Store.Json.*.nupkg \
                     ./nupkgs/Kode.Agent.Store.Redis.*.nupkg \
                     ./nupkgs/Kode.Agent.Mcp.*.nupkg; do
            if [ -f "$pkg" ]; then
              echo "Publishing $(basename $pkg)..."
              dotnet nuget push "$pkg" \
                --api-key ${{ secrets.NUGET_API_KEY }} \
                --source https://api.nuget.org/v3/index.json \
                --skip-duplicate
              sleep 10
            fi
          done
          
          echo "All packages published successfully to NuGet.org!"
      
      - name: Publish to GitHub Packages
        run: |
          echo "Publishing packages to GitHub Packages..."
          
          # 配置 GitHub Packages 源
          dotnet nuget add source --username JinFanZheng --password ${{ secrets.GITHUB_TOKEN }} \
            --store-password-in-clear-text --name github \
            "https://nuget.pkg.github.com/JinFanZheng/index.json"
          
          # 按相同顺序发布到 GitHub Packages
          echo "Publishing Kode.Agent.SourceGenerator to GitHub Packages..."
          dotnet nuget push ./nupkgs/Kode.Agent.SourceGenerator.*.nupkg \
            --source "github" \
            --skip-duplicate
          
          sleep 30
          
          echo "Publishing Kode.Agent.Sdk to GitHub Packages..."
          dotnet nuget push ./nupkgs/Kode.Agent.Sdk.*.nupkg \
            --source "github" \
            --skip-duplicate
          
          sleep 60
          
          echo "Publishing remaining packages to GitHub Packages..."
          for pkg in ./nupkgs/Kode.Agent.Tools.Builtin.*.nupkg \
                     ./nupkgs/Kode.Agent.Store.Json.*.nupkg \
                     ./nupkgs/Kode.Agent.Store.Redis.*.nupkg \
                     ./nupkgs/Kode.Agent.Mcp.*.nupkg; do
            if [ -f "$pkg" ]; then
              echo "Publishing $(basename $pkg) to GitHub Packages..."
              dotnet nuget push "$pkg" \
                --source "github" \
                --skip-duplicate
              sleep 5
            fi
          done
          
          echo "All packages published successfully to GitHub Packages!"
      
      - name: Upload packages as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./nupkgs/*.nupkg
          retention-days: 30
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ./nupkgs/*.nupkg
            ./nupkgs/*.snupkg
          generate_release_notes: true
          fail_on_unmatched_files: false
          draft: false
          prerelease: false
